define("block_aiassistant/chat",["exports","core/templates","./request","./session","./history"],(function(_exports,_templates,_request,_session,_history){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0;async function addMessage(role,text,time,chat){const{html:html,js:js}=await(0,_templates.renderForPromise)("block_aiassistant/messages",{role:role,text:text,time:time.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hourCycle:"h24"})});chat.insertAdjacentHTML("beforeend",html),chat.scrollTop=chat.scrollHeight,js&&(0,_templates.runTemplateJS)(js)}_exports.init=instanceid=>{console.log("âš¡ INIT WORK");const parent=document.querySelector(`[class="footer"][data-instance-id="${instanceid}"]`),submitButton=parent.querySelector('[data-action="submit"]'),textarea=parent.querySelector('[data-region="input"]'),chat=document.querySelector(`[data-role="chat"][data-instance-id="${instanceid}"]`),newChatButton=document.querySelector(`[data-action="new-chat"][data-instance-id="${instanceid}"]`);let session=null;(0,_session.getSession)().done((function(sessionInfo){if(session=sessionInfo.sessionid,console.log("currentSession:",sessionInfo),0==sessionInfo.isNew){(0,_history.loadHistory)(sessionInfo.sessionid).done((function(history){!async function(messages,chat){for(const message of messages)addMessage(message.role,message.text,new Date(1e3*message.time),chat)}(history,chat)})).fail((function(error){console.log("error",error)}))}})).fail((function(error){console.log("error",error)})),submitButton.addEventListener("click",(()=>{if(textarea){const text=textarea.value.trim();if(""!==text){const date=new Date,time=Math.floor(date.getTime()/1e3);addMessage("user",text,date,chat),textarea.value="";(0,_request.requestForAssistant)(text,time,session).done((function(response){"success"==response.status?(console.log("answer:",response.answer),addMessage("assistant",response.answer,new Date(1e3*response.answertime),chat)):console.log("error:",response.message)})).fail((function(fail){console.log("error",fail)}))}}else console.error("Textarea not found!")})),newChatButton.addEventListener("click",(()=>{chat.textContent="";(0,_session.getSession)(!0).done((function(sessionInfo){session=sessionInfo.sessionid,console.log("currentSession:",sessionInfo)})).fail((function(error){console.log("error",error)}))}))}}));

//# sourceMappingURL=chat.min.js.map