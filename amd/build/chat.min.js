define("block_aiassistant/chat",["exports","core/templates","./request","./session","./history"],(function(_exports,_templates,_request,_session,_history){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0;async function addMessage(role,text,time,chat){console.log("add message",text);const{html:html,js:js}=await(0,_templates.renderForPromise)("block_aiassistant/messages",{role:role,text:text,time:time.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hourCycle:"h24"})});chat.insertAdjacentHTML("beforeend",html),chat.scrollTop=chat.scrollHeight,js&&(0,_templates.runTemplateJS)(js)}_exports.init=instanceid=>{const parent=document.querySelector(`[class="footer"][data-instance-id="${instanceid}"]`),submitButton=parent.querySelector('[data-action="submit"]'),textarea=parent.querySelector('[data-region="input"]'),chat=document.querySelector(`[data-role="chat"][data-instance-id="${instanceid}"]`),newChatButton=document.querySelector(`[data-action="new-chat"][data-instance-id="${instanceid}"]`);let session=null;(0,_session.getSession)().done((function(sessionInfo){if(session=sessionInfo.sessionid,console.log("currentSession:",sessionInfo),0==sessionInfo.isNew){(0,_history.loadHistory)(sessionInfo.sessionid).done((function(history){!async function(messages,chat){for(const message of messages)addMessage(message.role,message.text,new Date(1e3*message.time),chat)}(history,chat)})).fail((function(error){console.log("error",error)}))}})).fail((function(error){console.log("error",error)})),submitButton.addEventListener("click",(()=>{if(textarea){const text=textarea.value.trim();if(""!==text){const savedDate=localStorage.getItem("savedDate"),currentDate=(new Date).toDateString();if(savedDate&&savedDate===currentDate)addMessage("assistant","You have send too many requests today. We are waiting for you tomorrow.",new Date,chat);else{const date=new Date,time=Math.floor(date.getTime()/1e3);addMessage("user",text,date,chat),textarea.value="",chat.insertAdjacentHTML("beforeend",'<div id="request-loading" class="loading-indicator"></div>');const loadingIndicator=chat.querySelector("#request-loading");(async function(text,time,session){try{const response=await(0,_request.requestForAssistant)(text,time,session);if("queue"==response.status)return console.log("id of request:",response.id),await async function(id){const interval=2e3,maxWaitingTime=3e4,startTime=Date.now();for(;Date.now()-startTime<maxWaitingTime;){console.log("checkStatus start");const response=await(0,_request.checkStatus)(id);if(console.log("checkStatus end",response.answer),"completed"===response.status)return{status:"success",answer:response.answer,answertime:response.answertime};if("failed"===response.status)throw new Error("Request failed");if("request_limit"===response.status)return{status:"request_limit"};await new Promise((resolve=>setTimeout(resolve,interval)))}throw new Error("Request timeout")}(response.id);if("request_limit"==response.status)return{status:response.status};throw console.log("error:",response.status),Error("invalid status of answer")}catch(error){throw console.log("error",error),error}})(text,time,session).then((response=>{if(loadingIndicator.remove(),"success"===response.status)addMessage("assistant",response.answer,new Date(1e3*response.answertime),chat);else if("request_limit"===response.status){const today=(new Date).toDateString();localStorage.setItem("savedDate",today),addMessage("assistant","You have send too many requests today. We are waiting for you tomorrow.",new Date,chat)}})).catch((()=>{loadingIndicator.remove(),addMessage("assistant","Sorry, something went wrong. Please try again.",new Date,chat)}))}}}else console.error("Textarea not found!")})),newChatButton.addEventListener("click",(()=>{chat.textContent="";(0,_session.getSession)(!0).done((function(sessionInfo){session=sessionInfo.sessionid,console.log("currentSession:",sessionInfo)})).fail((function(error){console.log("error",error)}))}))}}));

//# sourceMappingURL=chat.min.js.map