{"version":3,"file":"chat.min.js","sources":["../src/chat.js"],"sourcesContent":["import {renderForPromise, runTemplateJS} from 'core/templates';\nimport {requestForAssistant, checkStatus} from './request';\nimport {getSession} from './session';\nimport {loadHistory} from './history';\n\nexport const init = (instanceid) => {\n    const parent = document.querySelector(`[class=\"footer\"][data-instance-id=\"${instanceid}\"]`);\n    const submitButton = parent.querySelector('[data-action=\"submit\"]');\n    const textarea = parent.querySelector('[data-region=\"input\"]');\n    const chat = document.querySelector(`[data-role=\"chat\"][data-instance-id=\"${instanceid}\"]`);\n    const newChatButton = document.querySelector(`[data-action=\"new-chat\"][data-instance-id=\"${instanceid}\"]`);\n\n    let session = null;\n    const promise = getSession();\n    promise.done(function(sessionInfo) {\n        session = sessionInfo.sessionid;\n        // eslint-disable-next-line no-console\n        console.log(\"currentSession:\", sessionInfo);\n        if (sessionInfo.isNew == false) {\n            const promiseHistory = loadHistory(sessionInfo.sessionid);\n            promiseHistory.done(function(history) {\n                addDialogue(history, chat);\n            }).fail(function(error) {\n                // eslint-disable-next-line no-console\n                console.log(\"error\", error);\n            });\n        }\n    }).fail(function(error) {\n        // eslint-disable-next-line no-console\n        console.log(\"error\", error);\n    });\n\n    submitButton.addEventListener('click', () => {\n        if (textarea) {\n            const text = textarea.value.trim();\n            if (text !== '') {\n                const savedDate = localStorage.getItem('savedDate');\n                const currentDate = new Date().toDateString();\n                if (!savedDate || savedDate !== currentDate) {\n                    const date = new Date();\n                    const time = Math.floor(date.getTime() / 1000);\n                    addMessage('user', text, date, chat);\n                    textarea.value = '';\n                    chat.insertAdjacentHTML('beforeend',\n                        `<div id=\"request-loading\" class=\"loading-indicator\"></div>`\n                    );\n                    const loadingIndicator = chat.querySelector(\"#request-loading\");\n                    sendQuestion(text, time, session)\n                    .then(response => {\n                        loadingIndicator.remove();\n                        if (response.status === 'success') {\n                            addMessage('assistant', response.answer, new Date(response.answertime * 1000), chat);\n                        }\n                        else if (response.status === 'request_limit') {\n                            const today = new Date().toDateString();\n                            localStorage.setItem('savedDate', today);\n                            addMessage('assistant', 'You have send too many requests today. We are waiting for you tomorrow.',\n                                new Date(), chat);\n                        }\n                    })\n                    .catch(() => {\n                        loadingIndicator.remove();\n                        addMessage('assistant', 'Sorry, something went wrong. Please try again.', new Date(), chat);\n                    });\n                } else {\n                    addMessage('assistant', 'You have send too many requests today. We are waiting for you tomorrow.',\n                        new Date(), chat);\n                }\n            } else {\n                // Message for user: The message shouldn't be empty\n            }\n        } else {\n            // eslint-disable-next-line no-console\n            console.error('Textarea not found!');\n        }\n    });\n\n    newChatButton.addEventListener('click', () => {\n        chat.textContent = '';\n        const promise = getSession(true);\n        promise.done(function(sessionInfo) {\n            session = sessionInfo.sessionid;\n            // eslint-disable-next-line no-console\n            console.log(\"currentSession:\", sessionInfo);\n        }).fail(function(error) {\n            // eslint-disable-next-line no-console\n            console.log(\"error\", error);\n        });\n    });\n};\n/**\n * Add message\n * @param {'user' | 'assistant'} role\n * @param {string} text\n * @param {Data} time\n * @param {*} chat a message is added here\n */\nasync function addMessage(role, text, time, chat) {\n    // eslint-disable-next-line no-console\n    console.log(\"add message\", text);\n    const {html, js} = await renderForPromise('block_aiassistant/messages', {\n            role: role,\n            text: text,\n            time: time.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit', hourCycle: 'h24'})\n        });\n    chat.insertAdjacentHTML('beforeend', html);\n    chat.scrollTop = chat.scrollHeight;\n    if (js) {\n        runTemplateJS(js);\n    }\n}\n\n/**\n * Add message\n * @param {Array.<[string,string,number]>} messages\n * @param {*} chat a message is added here\n */\nasync function addDialogue(messages, chat) {\n    for (const message of messages) {\n        addMessage(message.role, message.text, new Date(message.time * 1000), chat);\n    }\n}\n\n/**\n * Send question to ai assistant\n * @param {string} text\n * @param {Date} time\n * @param {number} session\n * @returns {function} check the availability of the request result\n * @throws {Error}\n */\nasync function sendQuestion(text, time, session) {\n    try {\n        const response = await requestForAssistant(text, time, session);\n        if (response.status == \"queue\") {\n            // eslint-disable-next-line no-console\n            console.log(\"id of request:\", response.id);\n            return await waitForResult(response.id);\n        } else if (response.status == \"request_limit\") {\n            return {status: response.status};\n        } else {\n            // eslint-disable-next-line no-console\n            console.log(\"error:\", response.status);\n            throw Error(\"invalid status of answer\");\n        }\n    } catch (error) {\n        // eslint-disable-next-line no-console\n        console.log(\"error\", error);\n        throw error;\n    }\n}\n\n/**\n * Check the availability of the request result\n * @param {number} id\n */\nasync function waitForResult(id) {\n    const interval = 2000;\n    const maxWaitingTime = 30000;\n    const startTime = Date.now();\n    while (Date.now() - startTime < maxWaitingTime) {\n        // eslint-disable-next-line no-console\n        console.log(\"checkStatus start\");\n        const response = await checkStatus(id);\n        // eslint-disable-next-line no-console\n        console.log(\"checkStatus end\", response.answer);\n        if (response.status === 'completed') {\n            return {\n                status: 'success',\n                answer: response.answer,\n                answertime: response.answertime\n            };\n        } else if (response.status === 'failed') {\n            throw new Error('Request failed');\n        } else if (response.status === 'request_limit') {\n            return {status: 'request_limit'};\n        }\n        await new Promise(resolve => setTimeout(resolve, interval));\n    }\n    throw new Error('Request timeout');\n}"],"names":["async","addMessage","role","text","time","chat","console","log","html","js","renderForPromise","toLocaleTimeString","hour","minute","hourCycle","insertAdjacentHTML","scrollTop","scrollHeight","runTemplateJS","_exports","init","instanceid","parent","document","querySelector","submitButton","textarea","newChatButton","session","getSession","done","sessionInfo","sessionid","isNew","loadHistory","history","messages","message","Date","addDialogue","fail","error","addEventListener","value","trim","savedDate","localStorage","getItem","currentDate","toDateString","date","Math","floor","getTime","loadingIndicator","response","requestForAssistant","status","id","interval","maxWaitingTime","startTime","now","checkStatus","answer","answertime","Error","Promise","resolve","setTimeout","waitForResult","sendQuestion","then","remove","today","setItem","catch","textContent"],"mappings":"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"}